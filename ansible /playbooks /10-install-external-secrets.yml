---
- name: Install External Secrets Operator
  hosts: masters
  become_user: ubuntu
  tasks:
    - name: Add External Secrets Helm repository
      shell: helm repo add external-secrets https://charts.external-secrets.io
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Update Helm repositories
      shell: helm repo update
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Install External Secrets Operator
      shell: |
        helm upgrade --install external-secrets external-secrets/external-secrets \
          --namespace external-secrets-system \
          --create-namespace \
          --wait \
          --timeout 5m
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Wait for External Secrets Operator to be ready
      shell: kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=external-secrets -n external-secrets-system --timeout=300s
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Wait for CRDs to be fully available
      pause:
        seconds: 30

    - name: Verify External Secrets pods
      shell: kubectl get pods -n external-secrets-system
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: eso_pods

    - name: Display External Secrets pods
      debug:
        msg: "{{ eso_pods.stdout_lines }}"

    - name: Create Vault token secret for External Secrets first
      shell: |
        kubectl create secret generic vault-token \
          --from-literal=token=root \
          --namespace external-secrets-system \
          --dry-run=client -o yaml | kubectl apply -f -
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config

    - name: Create SecretStore for Vault integration
      shell: |
        cat <<YAML | kubectl apply -f -
        apiVersion: external-secrets.io/v1beta1
        kind: ClusterSecretStore
        metadata:
          name: vault-backend
        spec:
          provider:
            vault:
              server: "http://vault.vault.svc.cluster.local:8200"
              path: "secret"
              version: "v2"
              auth:
                tokenSecretRef:
                  name: vault-token
                  namespace: external-secrets-system
                  key: token
        YAML
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      retries: 3
      delay: 10
      register: secretstore_result
      until: secretstore_result.rc == 0

    - name: Verify ClusterSecretStore
      shell: kubectl get clustersecretstore
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: secretstore

    - name: Display ClusterSecretStore
      debug:
        msg: "{{ secretstore.stdout_lines }}"

    - name: Check ClusterSecretStore status
      shell: kubectl get clustersecretstore vault-backend -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: secretstore_status
      retries: 5
      delay: 10
      until: secretstore_status.stdout == "True"
      ignore_errors: yes

    - name: Display SecretStore readiness
      debug:
        msg: "ClusterSecretStore Ready: {{ secretstore_status.stdout }}"
